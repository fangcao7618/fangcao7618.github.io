<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="官网github地址：https://github.com/ReactiveX/rxjs 异步复杂度要到什么程度才需要用到Rxjs？给大家介绍一个很直观的网站，用动画的方式演示了大部分Rxjs的Operator的执行过程，以及功能相似的Operator之间的比较。https://reactive.how/RxJS至于event,就像以前Jquery至于dom，lodash/underscore至于">
<meta property="og:type" content="article">
<meta property="og:title" content="RxJS">
<meta property="og:url" content="http://yoursite.com/2019/07/04/yuque/RxJS/index.html">
<meta property="og:site_name" content="FangCao">
<meta property="og:description" content="官网github地址：https://github.com/ReactiveX/rxjs 异步复杂度要到什么程度才需要用到Rxjs？给大家介绍一个很直观的网站，用动画的方式演示了大部分Rxjs的Operator的执行过程，以及功能相似的Operator之间的比较。https://reactive.how/RxJS至于event,就像以前Jquery至于dom，lodash/underscore至于">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2019/png/263301/1562203964640-67f1c25c-d7c0-45df-bb9b-8be787157fb6.png#align=left&display=inline&height=84&name=image.png&originHeight=232&originWidth=828&size=85482&status=done&width=300">
<meta property="og:updated_time" content="2019-12-10T07:03:55.810Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RxJS">
<meta name="twitter:description" content="官网github地址：https://github.com/ReactiveX/rxjs 异步复杂度要到什么程度才需要用到Rxjs？给大家介绍一个很直观的网站，用动画的方式演示了大部分Rxjs的Operator的执行过程，以及功能相似的Operator之间的比较。https://reactive.how/RxJS至于event,就像以前Jquery至于dom，lodash/underscore至于">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2019/png/263301/1562203964640-67f1c25c-d7c0-45df-bb9b-8be787157fb6.png#align=left&display=inline&height=84&name=image.png&originHeight=232&originWidth=828&size=85482&status=done&width=300">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/07/04/yuque/RxJS/">





  <title>RxJS | FangCao</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f6bca865fcf2ff03fc0a96417de90b09";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>
<!-- 点击爆炸效果 -->
  
   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas>
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
   <script type="text/javascript" src="/js/src/fireworks.js"></script>
  
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">FangCao</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <!-- echarts -->
    <script type="text/javascript" src="/js/src/echarts.common.min.js"></script>
    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/04/yuque/RxJS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FangCao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/1916867.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FangCao">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RxJS</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-04T09:30:11+08:00">
                2019-07-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-12-10T15:03:55+08:00">
                2019-12-10
              </time>
            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.7k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  15 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="http://reactivex.io/" target="_blank" rel="noopener">官网</a><br>github地址：<a href="https://github.com/ReactiveX/rxjs" target="_blank" rel="noopener">https://github.com/ReactiveX/rxjs</a><br><a name="hjQZP"></a></p>
<h1 id="异步复杂度要到什么程度才需要用到Rxjs？"><a href="#异步复杂度要到什么程度才需要用到Rxjs？" class="headerlink" title="异步复杂度要到什么程度才需要用到Rxjs？"></a>异步复杂度要到什么程度才需要用到Rxjs？</h1><p>给大家介绍一个很直观的网站，用动画的方式演示了大部分Rxjs的Operator的执行过程，以及功能相似的Operator之间的比较。<br><a href="https://reactive.how/" target="_blank" rel="noopener"><img src="https://cdn.nlark.com/yuque/0/2019/png/263301/1562203964640-67f1c25c-d7c0-45df-bb9b-8be787157fb6.png#align=left&display=inline&height=84&name=image.png&originHeight=232&originWidth=828&size=85482&status=done&width=300" alt="image.png"></a><br><a href="https://reactive.how/" target="_blank" rel="noopener">https://reactive.how/</a><br>RxJS至于event,就像以前Jquery至于dom，lodash/underscore至于data。现在Jquery和lodash/underscore可以完全ES6+代替了。</p>
<p>用具体的实现例子去实现 RxJS, 原文地址 <a href="https://link.zhihu.com/?target=https%3A//css-tricks.com/animated-intro-rxjs/%23article-header-id-3" target="_blank" rel="noopener">An Animated Intro to RxJS | CSS-Tricks</a></p>
<p>hi 我也是初学者 来分享一点自己的心得<br>1. 从【能解决什么问题】开始学习rx到底是解决什么问题，是怎么解决得更好等等，来建立对rx的基本认识<br>途径: 百度，google，stackoverflow搜索<br>2. 从【一个简单可运行的demo】开始学习rx基本用法<br>途径-1: Hello RxJS系列（分享自知乎网）<br><a href="https://zhuanlan.zhihu.com/p/23331432" target="_blank" rel="noopener">知乎专栏</a><br>作者<br><a href="//www.zhihu.com/people/f169ccd8ba80a296455c2c0798ec343e">@太狼</a></p>
<p>途径-2: githun搜索rx demo<br>3. 【官网】开始学习rx 基本几大概念，api和用法等。最好每个api都动手做一做，下面分享的第二个网站有每个api的效果图。(我有些是边翻译边看哈哈)<br>分享-1: rx5.x官网<br><a href="https://link.zhihu.com/?target=http%3A//reactivex.io/rxjs/manual/overview.html" target="_blank" rel="noopener">http://reactivex.io/rxjs/manual/overview.html</a><br>分享-2: api效果图网<br><a href="https://link.zhihu.com/?target=http%3A//xgrommx.github.io/rx-book/content/observable/observable_instance_methods/flatmaplatest.html" target="_blank" rel="noopener">RxJS - Javascript library for functional reactive programming.</a><br>4. 【进阶】学习更多实际用途与基本原理<br>途径：angular2表单监控，angular2 http等<br>5. 【实战】开始用rxjs动手做个完整项目或者在根据项目情况中考虑加入rx<br>完</p>
<p><a name="ekvTt"></a></p>
<h1 id="构建流式应用—RxJS详解"><a href="#构建流式应用—RxJS详解" class="headerlink" title="构建流式应用—RxJS详解"></a>构建流式应用—RxJS详解</h1><p><a href="https://github.com/joeyguo/blog/issues/11" target="_blank" rel="noopener">原文地址</a><br>最近在 Alloyteam Conf 2016 分享了《使用RxJS构建流式前端应用》，会后在线上线下跟大家交流时发现对于 RxJS 的态度呈现出两大类:有用过的都表达了 RxJS 带来的优雅编码体验，未用过的则反馈太难入门。所以，这里将结合自己对 RxJS 理解，通过 RxJS 的实现原理、基础实现及实例来一步步分析，提供 RxJS 较为全面的指引，感受下使用 RxJS 编码是怎样的体验。<br><a name="TtDFo"></a></p>
<h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li>常规方式实现搜索功能</li>
<li>RxJS · 流 Stream</li>
<li>RxJS 实现原理简析<ul>
<li>观察者模式</li>
<li>迭代器模式</li>
<li>RxJS 的观察者 + 迭代器模式</li>
</ul>
</li>
<li>RxJS 基础实现<ul>
<li>Observable</li>
<li>Observer</li>
</ul>
</li>
<li>RxJS · Operators<ul>
<li>Operators ·入门</li>
<li>一系列的 Operators 操作</li>
</ul>
</li>
<li>使用 RxJS 一步步实现搜索功能</li>
<li>总结</li>
</ul>
<hr>
<p><a name="8MSM0"></a></p>
<h1 id="常规方式实现搜索"><a href="#常规方式实现搜索" class="headerlink" title="常规方式实现搜索"></a>常规方式实现搜索</h1><p>做一个搜索功能在前端开发中其实并不陌生，一般的实现方式是：监听文本框的输入事件，将输入内容发送到后台，最终将后台返回的数据进行处理并展示成搜索结果。<br><input id="text"><br><script><br />    var text = document.querySelector('#text');<br />    text.addEventListener('keyup', (e) =>{<br />        var searchText = e.target.value;<br />        // 发送输入内容到后台<br />        $.ajax({<br />            url: <code>search.qq.com/${searchText}</code>,<br />            success: data => {<br />              // 拿到后台返回数据，并展示搜索结果<br />              render(data);<br />            }<br />        });<br />    });<br /></script><br>上面代码实现我们要的功能，但存在两个较大的问题：</p>
<ol>
<li>多余的请求<br>当想搜索“爱迪生”时，输入框可能会存在三种情况，“爱”、“爱迪”、“爱迪生”。而这三种情况将会发起 3 次请求，存在 2 次多余的请求。<br></li>
<li>已无用的请求仍然执行<br>一开始搜了“爱迪生”，然后马上改搜索“达尔文”。结果后台返回了“爱迪生”的搜索结果，执行渲染逻辑后结果框展示了“爱迪生”的结果，而不是当前正在搜索的“达尔文”，这是不正确的。<br></li>
</ol>
<p><strong>减少多余请求数</strong>，可以用 setTimeout 函数节流的方式来处理，核心代码如下<br><input id="text"><br><script><br />    var text = document.querySelector('#text'),<br />        timer = null;<br />    text.addEventListener('keyup', (e) =>{<br />        // 在 250 毫秒内进行其他输入，则清除上一个定时器<br />        clearTimeout(timer);<br />        // 定时器，在 250 毫秒后触发<br />        timer = setTimeout(() => {<br />            console.log('发起请求..');<br />        },250)<br />    })<br /></script><br><strong>已无用的请求仍然执行</strong>的解决方式，可以在发起请求前声明一个当前搜索的状态变量，后台将搜索的内容及结果一起返回，前端判断返回数据与当前搜索是否一致，一致才走到渲染逻辑。最终代码为<br><input id="text"><br><script><br />    var text = document.querySelector('#text'),<br />        timer = null,<br />        currentSearch = '';</p>
<pre><code>text.addEventListener(&apos;keyup&apos;, (e) =&gt;{&lt;br /&gt;        clearTimeout(timer)&lt;br /&gt;        timer = setTimeout(() =&gt; {&lt;br /&gt;            // 声明一个当前所搜的状态变量&lt;br /&gt;            currentSearch ＝ &apos;书&apos;; 

        var searchText = e.target.value;&lt;br /&gt;            $.ajax({&lt;br /&gt;                url: `search.qq.com/${searchText}`,&lt;br /&gt;                success: data =&gt; {&lt;br /&gt;                    // 判断后台返回的标志与我们存的当前搜索变量是否一致&lt;br /&gt;                    if (data.search === currentSearch) {&lt;br /&gt;                        // 渲染展示&lt;br /&gt;                        render(data);&lt;br /&gt;                    } else {&lt;br /&gt;                        // ..&lt;br /&gt;                    }&lt;br /&gt;                }           &lt;br /&gt;            });&lt;br /&gt;        },250)&lt;br /&gt;    })&lt;br /&gt;&lt;/script&gt;&lt;br /&gt;上面代码基本满足需求，但代码开始显得乱糟糟。我们来使用 RxJS 实现上面代码功能，如下&lt;br /&gt;var text = document.querySelector(&apos;#text&apos;);&lt;br /&gt;var inputStream = Rx.Observable.fromEvent(text, &apos;keyup&apos;)&lt;br /&gt;                    .debounceTime(250)&lt;br /&gt;                    .pluck(&apos;target&apos;, &apos;value&apos;)&lt;br /&gt;                    .switchMap(url =&gt; Http.get(url))&lt;br /&gt;                    .subscribe(data =&gt; render(data));&lt;br /&gt;可以明显看出，**基于 RxJS 的实现，代码十分简洁！**</code></pre><p><a name="zLFnv"></a></p>
<h1 id="RxJS-·-流-Stream"><a href="#RxJS-·-流-Stream" class="headerlink" title="RxJS · 流 Stream"></a>RxJS · 流 Stream</h1><p>RxJS 是 Reactive Extensions for JavaScript 的缩写，起源于 Reactive Extensions，是一个基于可观测数据流在异步编程应用中的库。RxJS 是 Reactive Extensions 在 JavaScript 上的实现，而其他语言也有相应的实现，如 RxJava、RxAndroid、RxSwift 等。学习 RxJS，我们需要从可观测数据流(Streams)说起，它是 Rx 中一个重要的数据类型。<br /><strong>流</strong>是在时间流逝的过程中产生的一系列事件。它具有时间与事件响应的概念。<br /><img src="https://cdn.nlark.com/yuque/0/2019/gif/263301/1562224751759-68a17e33-91ff-4f22-8f0a-3506139c4f40.gif#align=left&display=inline&height=281&name=c.gif&originHeight=281&originWidth=500&size=1348260&status=done&width=500" alt="c.gif"><br />下雨天时，雨滴随时间推移逐渐产生，下落时对水面产生了水波纹的影响，这跟 Rx 中的流是很类似的。而在 Web 中，雨滴可能就是一系列的鼠标点击、键盘点击产生的事件或数据集合等等。<br><a name="RwwLZ"></a></p>
<h1 id="RxJS-基础实现原理简析"><a href="#RxJS-基础实现原理简析" class="headerlink" title="RxJS 基础实现原理简析"></a>RxJS 基础实现原理简析</h1><p>对流的概念有一定理解后，我们来讲讲 RxJS 是怎么围绕着流的概念来实现的，讲讲 RxJS 的基础实现原理。RxJS 是基于观察者模式和迭代器模式以函数式编程思维来实现的。<br><a name="UydvK"></a></p>
<h2 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h2><p>观察者模式在 Web 中最常见的应该是 DOM 事件的监听和触发。</p>
<ul>
<li><strong>订阅</strong>：通过 addEventListener 订阅 document.body 的 click 事件。</li>
<li><strong>发布</strong>：当 body 节点被点击时，body 节点便会向订阅者发布这个消息。</li>
</ul>
<p>document.body.addEventListener('click', function listener(e) {<br />    console.log(e);<br />},false);</p>
<p>document.body.click(); // 模拟用户点击<br />将上述例子抽象模型，并对应通用的观察者模型<br /><a href="https://cloud.githubusercontent.com/assets/10385585/19889545/58dababe-a070-11e6-8e54-be78121f9ba1.png"><img src="https://cdn.nlark.com/yuque/0/2019/png/263301/1562224636723-3c7075b7-336a-40ca-b0d8-d9380825d5cd.png#align=left&display=inline&height=423&originHeight=423&originWidth=915&size=0&status=done&width=915" alt=""></a><br><a name="o8XKV"></a></p>
<h2 id="迭代器模式"><a href="#迭代器模式" class="headerlink" title="迭代器模式"></a>迭代器模式</h2><p>迭代器模式可以用 JavaScript 提供了 Iterable Protocol 可迭代协议来表示。Iterable Protocol 不是具体的变量类型，而是一种可实现协议。JavaScript 中像 Array、Set 等都属于内置的可迭代类型，可以通过 iterator 方法来获取一个迭代对象，调用迭代对象的 next 方法将获取一个元素对象，如下示例。<br />var iterable = [1, 2];</p>
<p>var iterator = iterable<a href="">Symbol.iterator</a>;</p>
<p>iterator.next(); // => { value: "1", done: false}<br />iterator.next(); // => { value: "2", done: false}</p>
<p>iterator.next(); // => { value: undefined, done: true}<br />元素对象中：value 表示返回值，done 表示是否已经到达最后。<br />遍历迭代器可以使用下面做法。<br />var iterable = [1, 2];<br />var iterator = iterable<a href="">Symbol.iterator</a>;</p>
<p>while(true) {<br />    let result;<br />    try {<br />        result = iterator.next();  // <= 获取下一个值<br />    } catch (err) {<br />        handleError(err);  // <= 错误处理<br />    }<br />    if (result.done) {<br />        handleCompleted();  // <= 无更多值（已完成）<br />        break;<br />    }<br />    doSomething(result.value);<br />}<br />主要对应三种情况：</p>
<ul>
<li><p>获取下一个值<br />调用 next 可以将元素一个个地返回，这样就支持了返回多次值。<br /></p>
</li>
<li><p>无更多值(已完成)<br />当无更多值时，next 返回元素中 done 为 true。<br /></p>
</li>
<li><p>错误处理<br />当 next 方法执行时报错，则会抛出 error 事件，所以可以用 try catch 包裹 next 方法处理可能出现的错误。<br /><br><a name="r8Owr"></a></p>
<h2 id="RxJS-的观察者-迭代器模式"><a href="#RxJS-的观察者-迭代器模式" class="headerlink" title="RxJS 的观察者 + 迭代器模式"></a>RxJS 的观察者 + 迭代器模式</h2><p>RxJS 中含有两个基本概念：Observables 与 Observer。Observables 作为被观察者，是一个值或事件的流集合；而 Observer 则作为观察者，根据 Observables 进行处理。<br />Observables 与 Observer 之间的订阅发布关系(观察者模式) 如下：</p>
</li>
<li><p><strong>订阅</strong>：Observer 通过 Observable 提供的 subscribe() 方法订阅 Observable。</p>
</li>
<li><p><strong>发布</strong>：Observable 通过回调 next 方法向 Observer 发布事件。</p>
</li>
</ul>
<p>下面为 Observable 与 Observer 的伪代码<br />// Observer<br />var Observer = {<br />    next(value) {<br />        alert(<code>收到${value}</code>);<br />    }<br />};</p>
<p>// Observable<br />function Observable (Observer) {<br />    setTimeout(()=>{<br />        Observer.next('A');<br />    },1000)<br />}</p>
<p>// subscribe<br />Observable(Observer);<br />上面实际也是观察者模式的表现，那么迭代器模式在 RxJS 中如何体现呢？<br />在 RxJS 中，Observer 除了有 next 方法来接收 Observable 的事件外，还可以提供了另外的两个方法：error() 和 complete()，与迭代器模式一一对应。<br />var Observer = {<br />    next(value) { /* 处理值<em>/ },<br />    error(error) { /</em> 处理异常 <em>/ },<br />    complete() { /</em> 处理已完成态 */ }<br />};<br />结合迭代器 Iterator 进行理解：</p>
<ul>
<li><strong>next()</strong><br />Observer 提供一个 next 方法来接收 Observable 流，是一种 push 形式；而 Iterator 是通过调用 iterator.next() 来拿到值，是一种 pull 的形式。<br /></li>
<li><strong>complete()</strong><br />当不再有新的值发出时，将触发 Observer 的 complete 方法；而在 Iterator 中，则需要在 next 的返回结果中，当返回元素 done 为 true 时，则表示 complete。<br /></li>
<li><strong>error()</strong><br />当在处理事件中出现异常报错时，Observer 提供 error 方法来接收错误进行统一处理；Iterator 则需要进行 try catch 包裹来处理可能出现的错误。<br /></li>
</ul>
<p>下面是 Observable 与 Observer 实现观察者 + 迭代器模式的伪代码，数据的逐渐传递传递与影响其实就是流的表现。<br />// Observer<br />var Observer = {<br />    next(value) {<br />        alert(<code>收到${value}</code>);<br />    },<br />    error(error) {<br />        alert(<code>收到${error}</code>);<br />    },<br />    complete() {<br />        alert("complete");<br />    },<br />};</p>
<p>// Observable<br />function Observable (Observer) {<br />    [1,2,3].map(item=>{<br />        Observer.next(item);<br />    });</p>
<pre><code>Observer.complete();&lt;br /&gt;    // Observer.error(&quot;error message&quot;);&lt;br /&gt;}</code></pre><p>// subscribe<br />Observable(Observer);<br><a name="QC1vM"></a></p>
<h1 id="RxJS-基础实现"><a href="#RxJS-基础实现" class="headerlink" title="RxJS 基础实现"></a>RxJS 基础实现</h1><p>有了上面的概念及伪代码，那么在 RxJS 中是怎么创建 Observable 与 Observer 的呢?<br><a name="YZPbn"></a></p>
<h3 id="创建-Observable"><a href="#创建-Observable" class="headerlink" title="创建 Observable"></a>创建 Observable</h3><p>RxJS 提供 create 的方法来自定义创建一个 Observable，可以使用 next 来发出流。<br />var Observable = Rx.Observable.create(observer => {<br />    observer.next(2);<br />    observer.complete();<br />    return  () => console.log('disposed');<br />});<br><a name="9zN6u"></a></p>
<h3 id="创建-Observer"><a href="#创建-Observer" class="headerlink" title="创建 Observer"></a>创建 Observer</h3><p>Observer 可以声明 next、err、complete 方法来处理流的不同状态。<br />var Observer = Rx.Observer.create(<br />    x => console.log('Next:', x),<br />    err => console.log('Error:', err),<br />    () => console.log('Completed')<br />);<br />最后将 Observable 与 Observer 通过 subscribe 订阅结合起来。<br />var subscription = Observable.subscribe(Observer);<br />RxJS 中流是可以被取消的，调用 subscribe 将返回一个 subscription，可以通过调用 subscription.unsubscribe() 将流进行取消，让流不再产生。<br />看了起来挺复杂的？换一个实现形式：<br />// @Observables 创建一个 Observables<br />var streamA = Rx.Observable.of(2);</p>
<p>// @Observer streamA$.subscribe(Observer)<br />streamA.subscribe(v => console.log(v));<br />将上面代码改用链式写法，代码变得十分简洁：<br />Rx.Observable.of(2).subscribe(v => console.log(v));<br><a name="1jiUR"></a></p>
<h1 id="RxJS-·-Operators-操作"><a href="#RxJS-·-Operators-操作" class="headerlink" title="RxJS · Operators 操作"></a>RxJS · Operators 操作</h1><p><a name="DmlXg"></a></p>
<h2 id="Operators-操作·入门"><a href="#Operators-操作·入门" class="headerlink" title="Operators 操作·入门"></a>Operators 操作·入门</h2><p>Rx.Observable.of(2).subscribe(v => console.log(v));<br />上面代码相当于创建了一个流(2)，最终打印出2。那么如果想将打印结果翻倍，变成4，应该怎么处理呢？<br /><strong>方案一?</strong>： 改变事件源，让 Observable 值 X 2<br />Rx.Observable.of(2 * 2 /* <= <em>/).subscribe(v => console.log(v));<br /><strong>方案二?</strong>： 改变响应方式，让 Observer 处理 X 2<br />Rx.Observable.of(2).subscribe(v => console.log(v * 2 /</em> <= <em>/));<br /><strong>优雅方案</strong>： RxJS 提供了优雅的处理方式，可以在事件源(Observable)与响应者(Observer)之间增加操作流的方法。<br />Rx.Observable.of(2)<br />             .map(v => v * 2) /</em> <= */<br />             .subscribe(v => console.log(v));<br />map 操作跟数组操作的作用是一致的，不同的这里是将流进行改变，然后将新的流传出去。在 RxJS 中，把这类操作流的方式称之为 Operators(操作)。RxJS提供了一系列 Operators，像map、reduce、filter 等等。操作流将产生新流，从而保持流的不可变性，这也是 RxJS 中函数式编程的一点体现。关于函数式编程，这里暂不多讲，可以看看另外一篇文章 <a href="https://github.com/joeyguo/blog/issues/10">《谈谈函数式编程》</a><br />到这里，我们知道了，流从产生到最终处理，可能经过的一些操作。即 RxJS 中 Observable 将经过一系列 Operators 操作后，到达 Observer。<br />Operator1   Operator2<br />Observable ----|-----------|-------> Observer<br><a name="cvj5t"></a></p>
<h2 id="一系列的-Operators-操作"><a href="#一系列的-Operators-操作" class="headerlink" title="一系列的 Operators 操作"></a>一系列的 Operators 操作</h2><p>RxJS 提供了非常多的操作，像下面这些。<br />Aggregate,All,Amb,ambArray,ambWith,AssertEqual,averageFloat,averageInteger,averageLong,blocking,blockingFirst,blockingForEach,blockingSubscribe,Buffer,bufferWithCount,bufferWithTime,bufferWithTimeOrCount,byLine,cache,cacheWithInitialCapacity,case,Cast,Catch,catchError,catchException,collect,concatWith,Connect,connect_forever,cons,Contains,doAction,doAfterTerminate,doOnComplete,doOnCompleted,doOnDispose,doOnEach,doOnError,doOnLifecycle,doOnNext,doOnRequest,dropUntil,dropWhile,ElementAt,ElementAtOrDefault,emptyObservable,fromNodeCallback,fromPromise,fromPublisher,fromRunnable,Generate,generateWithAbsoluteTime,generateWithRelativeTime,Interval,intervalRange,into,latest (Rx.rb version of Switch),length,mapTo,mapWithIndex,Materialize,Max,MaxBy,mergeArray,mergeArrayDelayError,mergeWith,Min,MinBy,multicastWithSelector,nest,Never,Next,Next (BlockingObservable version),partition,product,retryWhen,Return,returnElement,returnValue,runAsync,safeSubscribe,take_with_time,takeFirst,TakeLast,takeLastBuffer,takeLastBufferWithTime,windowed,withFilter,withLatestFrom,zipIterable,zipWith,zipWithIndex<br />关于每一个操作的含义，可以查看<a href="http://reactivex.io/documentation/operators.html">官网</a>进行了解。operators 具有静态（static）方法和实例（ instance）方法，下面使用 Rx.Observable.xx 和 Rx.Observable.prototype.xx 来简单区分，举几个例子。<br /><strong>Rx.Observable.of</strong><br />of 可以将普通数据转换成流式数据 Observable。如上面的 Rx.Observable.of(2)。<br /><strong>Rx.Observable.fromEvent</strong><br />除了数值外，RxJS 还提供了关于事件的操作，fromEvent 可以用来监听事件。当事件触发时，将事件 event 转成可流动的 Observable 进行传输。下面示例表示：监听文本框的 keyup 事件，触发 keyup 可以产生一系列的 event Observable。<br />var text = document.querySelector('#text');<br />Rx.Observable.fromEvent(text, 'keyup')<br />             .subscribe(e => console.log(e));<br /><strong>Rx.Observable.prototype.map</strong><br />map 方法跟我们平常使用的方式是一样的，不同的只是这里是将流进行改变，然后将新的流传出去。上面示例已有涉及，这里不再多讲。<br />Rx.Observable.of(2)<br />             .map(v => 10 * v)<br />             .subscribe(v => console.log(v));<br />Rx 提供了许多的操作，为了更好的理解各个操作的作用，我们可以通过一个可视化的工具 <a href="http://rxmarbles.com/">marbles 图</a> 来辅助理解。如 map 方法对应的 marbles 图如下<br /><a href="https://cloud.githubusercontent.com/assets/10385585/19889586/9af9d4ca-a070-11e6-8582-8dbdcfcef520.png"><img src="https://cdn.nlark.com/yuque/0/2019/png/263301/1562224637404-cb22087f-9fda-4234-a8bd-8a211fd52991.png#align=left&display=inline&height=428&originHeight=428&originWidth=1098&size=0&status=done&width=1098" alt=""></a><br />箭头可以理解为时间轴，上面的数据经过中间的操作，转变成下面的模样。<br /><strong>Rx.Observable.prototype.mergeMap</strong><br />mergeMap 也是 RxJS 中常用的接口，我们来结合 marbles 图(flatMap(alias))来理解它<br /><a href="https://cloud.githubusercontent.com/assets/10385585/19889614/cb4bed20-a070-11e6-9de0-7f04d8de53cc.png"><img src="https://cdn.nlark.com/yuque/0/2019/png/263301/1562224637493-53b74d3b-8131-49cf-9894-601e4b0fcb9e.png#align=left&display=inline&height=494&originHeight=494&originWidth=1064&size=0&status=done&width=1064" alt=""></a><br />上面的数据流中，产生了新的分支流(流中流)，mergeMap 的作用则是将分支流调整回主干上，最终分支上的数据流都经过主干的其他操作，其实也是将流中流进行扁平化。<br /><strong>Rx.Observable.prototype.switchMap</strong><br />switchMap 与 mergeMap 都是将分支流疏通到主干上，而不同的地方在于 switchMap 只会保留最后的流，而取消抛弃之前的流。<br />除了上面提到的 marbles，也可以 ASCII 字符的方式来绘制可视化图表，下面将结合 Map、mergeMap 和 switchMap 进行对比来理解。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Map             @mergeMap            @switchMap</span><br><span class="line">                         ↗  ↗                 ↗  ↗</span><br><span class="line">-A------B--&gt;           a2 b2                a2 b2  </span><br><span class="line">-2A-----2B-&gt;          /  /                 /  /  </span><br><span class="line">                    /  /                 /  /</span><br><span class="line">                  a1 b1                a1 b1</span><br><span class="line">                 /  /                 /  /</span><br><span class="line">                -A-B-----------&gt;     -A-B----------&gt;</span><br><span class="line">                --a1-b1-a2-b2--&gt;     --a1-b1---b2--&gt;</span><br></pre></td></tr></table></figure>

<p>mergeMap 和 switchMap 中，A 和 B 是主干上产生的流，a1、a2 为 A 在分支上产生，b1、b2 为 B 在分支上产生，可看到，最终将归并到主干上。switchMap 只保留最后的流，所以将 A 的 a2 抛弃掉。<br /><strong>Rx.Observable.prototype.debounceTime</strong><br />debounceTime 操作可以操作一个时间戳 TIMES，表示经过 TIMES 毫秒后，没有流入新值，那么才将值转入下一个操作。<br /><a href="https://cloud.githubusercontent.com/assets/10385585/19889647/f6ce3aac-a070-11e6-8a35-b04f05afbe36.png"><img src="https://cdn.nlark.com/yuque/0/2019/png/263301/1562224636984-6bc3f28f-4f3d-44a6-a530-11498638ea33.png#align=left&display=inline&height=421&originHeight=421&originWidth=1089&size=0&status=done&width=1089" alt=""></a><br />RxJS 中的操作符是满足我们以前的开发思维的，像 map、reduce 这些。另外，无论是 marbles 图还是用 ASCII 字符图这些可视化的方式，都对 RxJS 的学习和理解有非常大的帮助。<br><a name="dg75Y"></a></p>
<h1 id="使用-RxJS-一步步实现搜索示例"><a href="#使用-RxJS-一步步实现搜索示例" class="headerlink" title="使用 RxJS 一步步实现搜索示例"></a>使用 RxJS 一步步实现搜索示例</h1><p>RxJS 提供许多创建流或操作流的接口，应用这些接口，我们来一步步将搜索的示例进行 Rx 化。<br />使用 RxJS 提供的 fromEvent 接口来监听我们输入框的 keyup 事件，触发 keyup 将产生 Observable。<br />var text = document.querySelector('#text');<br />Rx.Observable.fromEvent(text, 'keyup')<br />             .subscribe(e => console.log(e));<br />这里我们并不想输出事件，而想拿到文本输入值，请求搜索，最终渲染出结果。涉及到两个新的 Operators 操作，简单理解一下：</p>
<ul>
<li><strong>Rx.Observable.prototype.pluck('target', 'value')</strong><br />将输入的 event，输出成 event.target.value。<br /></li>
<li><strong>Rx.Observable.prototype.mergeMap()</strong><br />将请求搜索结果输出回给 Observer 上进行渲染。<br /></li>
</ul>
<p>var text = document.querySelector('#text');<br />Rx.Observable.fromEvent(text, 'keyup')<br />             .pluck('target', 'value') // <--<br />             .mergeMap(url => Http.get(url)) // <--<br />             .subscribe(data => render(data))<br />上面代码实现了简单搜索呈现，但同样存在一开始提及的两个问题。那么如何减少请求数，以及取消已无用的请求呢？我们来了解 RxJS 提供的其他 Operators 操作，来解决上述问题。</p>
<ul>
<li><strong>Rx.Observable.prototype.debounceTime(TIMES)</strong><br />表示经过 TIMES 毫秒后，没有流入新值，那么才将值转入下一个环节。这个与前面使用 setTimeout 来实现函数节流的方式有一致效果。<br /></li>
<li><strong>Rx.Observable.prototype.switchMap()</strong><br />使用 switchMap 替换 mergeMap，将能取消上一个已无用的请求，只保留最后的请求结果流，这样就确保处理展示的是最后的搜索的结果。<br /></li>
</ul>
<p>最终实现如下，与一开始的实现进行对比，可以明显看出 RxJS 让代码变得十分简洁。<br />var text = document.querySelector('#text');<br />Rx.Observable.fromEvent(text, 'keyup')<br />             .debounceTime(250) // <- throttling behaviour<br />             .pluck('target', 'value')<br />             .switchMap(url => Http.get(url)) // <- Kill the previous requests<br />             .subscribe(data => render(data))<br><a name="9lqho"></a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本篇作为 RxJS 入门篇到这里就结束，关于 RxJS 中的其他方面内容，后续再拎出来进一步分析学习。<br />RxJS 作为一个库，可以与众多框架结合使用，但并不是每一种场合都需要使用到 RxJS。复杂的数据来源，异步多的情况下才能更好凸显 RxJS 作用，这一块可以看看民工叔写的<a href="https://github.com/xufei/blog/issues/38">《流动的数据——使用 RxJS 构造复杂单页应用的数据逻辑》</a> 相信会有更好的理解。<br />附:<br />RxJS(JavaScript) <a href="https://github.com/Reactive-Extensions/RxJS">https://github.com/Reactive-Extensions/RxJS</a><br />RxJS(TypeScript ) <a href="https://github.com/ReactiveX/rxjs">https://github.com/ReactiveX/rxjs</a><br /><a href="https://github.com/joeyguo/blog">查看更多文章 >></a><br /><a href="https://github.com/joeyguo/blog">https://github.com/joeyguo/blog</a></p>
</script></p>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/03/yuque/CSS 实现类似原生效果的 1px 边框/" rel="next" title="CSS 实现类似原生效果的 1px 边框">
                <i class="fa fa-chevron-left"></i> CSS 实现类似原生效果的 1px 边框
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/04/yuque/create-react-app创建的项目中registerServiceWorker.js文件的作用/" rel="prev" title="create-react-app创建的项目中registerServiceWorker.js文件的作用">
                create-react-app创建的项目中registerServiceWorker.js文件的作用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80NDgxOC8yMTMzOQ=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/1916867.png" alt="FangCao">
            
              <p class="site-author-name" itemprop="name">FangCao</p>
              <p class="site-description motion-element" itemprop="description">天空不留下鸟的痕迹，但我已飞过；流星是美丽的不为永恒，只为瞬间</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">185</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/fang-cao-2-96" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-zhihu"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:wangfangcao7618@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/wangfangcao7618" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://macshuo.com/" title="MacTalk" target="_blank">MacTalk</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://example.com/" title="Title" target="_blank">Title</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#异步复杂度要到什么程度才需要用到Rxjs？"><span class="nav-number">1.</span> <span class="nav-text">异步复杂度要到什么程度才需要用到Rxjs？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#构建流式应用—RxJS详解"><span class="nav-number">2.</span> <span class="nav-text">构建流式应用—RxJS详解</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#目录"><span class="nav-number">3.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#常规方式实现搜索"><span class="nav-number">4.</span> <span class="nav-text">常规方式实现搜索</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2012 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FangCao</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">321.9k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  <!--添加复制-->
  <script type="text/javascript" src="/lib/zclip/clipboard.min.js"></script>
<script type="text/javascript" src="/js/src/custom.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"width":150,"height":300,"position":"right"},"mobile":{"show":true,"scale":0.5},"react":{"opacity":0.9},"dialog":{"enable":true,"hitokoto":true},"log":false});</script></body>
<!-- 页面点击小红心 <script type="text/javascript" src="/js/src/click.js"></script> -->
</html>
